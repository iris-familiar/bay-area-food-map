# 搜索策略轮换机制

## 问题
如果搜索词固定，局限度太大：
- 每天都搜"湾区美食" → 重复内容
- 每周都搜同样城市 → 遗漏其他地区
- 菜系覆盖不全 → 发现不了小众餐厅

## 解决方案

### 动态轮换机制
根据**周几**和**第几周**自动选择不同的搜索词

```
今天是: 周一 (第3周)

场景搜索: 湾区约会餐厅, 湾区情侣餐厅  (周一场景)
菜系搜索: 湾区日料, 湾区寿司          (第3周=日料周)
卫星城市: Newark美食, Hayward美食     (第3周=东湾扩展)
```

## 周数计算修复

### 问题
2月有29-31日，会计算出**第5周**，但词库只有4周：
```
29日 -> 第5周 ❌ (超出范围)
```

### 解决方案
使用**取模运算**，让第5周循环回第1周：
```python
def get_week_of_month():
    week = (day_of_month - 1) // 7 + 1
    return ((week - 1) % 4) + 1  # 1-4循环
```

### 修复后效果
```
第1周: 1-7日, 29日
第2周: 8-14日, 30日  
第3周: 15-21日, 31日
第4周: 22-28日
```

**29-31日自动循环到第1-3周，不会超出范围！**

| 周几 | 搜索词 |
|------|--------|
| 周一 | 湾区约会餐厅、湾区情侣餐厅、湾区浪漫餐厅 |
| 周二 | 湾区家庭聚餐、湾区带孩子吃饭、湾区亲子餐厅 |
| 周三 | 湾区一人食、湾区独自吃饭、湾区工作餐 |
| 周四 | 湾区朋友聚餐、湾区同事聚餐、湾区同学聚会 |
| 周五 | 湾区周末聚餐、湾区周五聚餐、湾区放松吃饭 |
| 周六 | 湾区必吃、湾区网红餐厅、湾区local推荐 |
| 周日 | 湾区避雷、湾区踩雷、湾区避坑 |

**效果**: 7天不重样，覆盖各种用餐场景

### 2. 菜系搜索 (每周轮换)

| 第几周 | 菜系 |
|--------|------|
| 第1周 | 湾区川菜、湾区湘菜、湾区粤菜、湾区火锅 |
| 第2周 | 湾区烧烤、湾区早茶、湾区点心、湾区拉面 |
| 第3周 | 湾区日料、湾区寿司、湾区日式拉面、湾区烧鸟 |
| 第4周 | 湾区韩餐、湾区泰国菜、湾区越南菜、湾区pho |

**效果**: 4周覆盖12+菜系

### 3. 卫星城市 (每周轮换)

| 第几周 | 城市 |
|--------|------|
| 第1周 | Los Gatos, Saratoga, Campbell, Los Altos, Menlo Park |
| 第2周 | Redwood City, San Mateo, Burlingame, Millbrae, San Bruno |
| 第3周 | Newark, Hayward, San Leandro, Oakland, Berkeley |
| 第4周 | Dublin, Pleasanton, Walnut Creek, San Francisco |

**效果**: 4周覆盖20+城市

## 4周完整覆盖

```
第1周: 中餐 + 南湾扩展
第2周: 中餐2 + 半岛扩展
第3周: 日料 + 东湾扩展
第4周: 韩东南亚 + 远郊+SF
```

**总计**: 20+城市 × 12+菜系 × 7种场景 = 无限组合

## 代码实现

```python
# scripts/search_rotation.py

def get_today_queries():
    weekday = get_weekday()      # 0-6 (周一到周日)
    week_of_month = get_week_of_month()  # 1-4
    
    # 场景搜索 (每天不同)
    scene = SCENE_QUERIES[weekday][:2]
    
    # 菜系搜索 (每周轮换)
    cuisine_week = ["中餐周1", "中餐周2", "日料周", "韩东南亚周"]
    cuisine = CUISINE_QUERIES[cuisine_week[week_of_month-1]][:2]
    
    # 卫星城市 (每周轮换)
    city_week = ["南湾扩展", "半岛扩展", "东湾扩展", "远郊SF"]
    cities = SATELLITE_CITIES[city_week[week_of_month-1]][:2]
    
    return scene + cuisine + cities
```

## 使用效果

### 每日搜索词示例

**周一第1周**:
- 场景: 湾区约会餐厅, 湾区情侣餐厅
- 菜系: 湾区川菜, 湾区湘菜
- 城市: Los Gatos美食, Saratoga美食

**周三第3周**:
- 场景: 湾区一人食, 湾区独自吃饭
- 菜系: 湾区日料, 湾区寿司
- 城市: Newark美食, Hayward美食

**周五第2周**:
- 场景: 湾区周末聚餐, 湾区周五聚餐
- 菜系: 湾区烧烤, 湾区早茶
- 城市: Redwood City美食, San Mateo美食

### 避免重复

4周后才会重复同样的菜系+城市组合:
- 川菜+Los Gatos → 4周后再次出现
- 日料+Newark → 4周后再次出现

## 与Cron Job集成

```json
{
  "name": "小红书餐厅数据综合维护-v2",
  "schedule": "0 2 * * *",
  "tasks": [
    "1. 执行 search_rotation.py 获取今日搜索词",
    "2. 对每个搜索词执行Xiaohongshu搜索",
    "3. LLM提取餐厅名和推荐菜",
    "4. Google验证",
    "5. QA验证",
    "6. 部署"
  ]
}
```

## 优势

1. **自动化**: 无需人工调整搜索词
2. **全覆盖**: 4周覆盖所有城市+菜系
3. **不重复**: 避免搜索同样内容
4. **持续性**: 长期运行不断发现新餐厅

## 预期增量

| 时间 | 预计新增 |
|------|----------|
| 每日 | 0-2家 |
| 每周 | 5-10家 |
| 每月 | 20-30家 |
| 3个月后 | 150家 |
| 6个月后 | 250家 |
