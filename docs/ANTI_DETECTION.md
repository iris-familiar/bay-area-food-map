# 小红书数据获取 - 防封号策略

**最后更新**: 2026-02-15  
**目标**: 在获取100+高质量帖子的同时，保持账号安全

---

## 核心原则

**模拟人类行为，避免机器特征**

小红书的风控系统主要检测：
1. 请求频率异常 (固定间隔、过快)
2. 行为模式机械 (无停顿、无随机性)
3. 单日请求量过大
4. 请求时间异常 (深夜高频)

---

## 已实施的防护措施

### 1. 随机延迟策略

```bash
# 单帖获取间隔
随机 3-8秒 (而非固定2秒)

# 每5帖后长休息  
固定 15秒

# 关键词间隔
随机 8-15秒 (而非固定3秒)

# 每3关键词批次休息
随机 20-30秒

# 每10关键词阶段休息
固定 60秒
```

### 2. 减少单次请求量

```bash
# 修改前: 每次搜索返回20条
# 修改后: 每次搜索返回15条 (更自然)

# 只获取评论数≥5的帖子详情
# 跳过已存在的文件 (避免重复请求)
```

### 3. 分时执行建议

```bash
# 单日上限: 30-50个帖子 (保守策略)
# 推荐分3天执行:

# Day 1: 核心关键词 (10个)
./pipeline.sh fetch  # 预计获取 15-25帖

# Day 2: 地理关键词 (15个)  
./scripts/fetch_xiaohongshu_data.sh search  # 预计获取 20-30帖

# Day 3: 菜系+场景关键词 (15个)
# 预计获取 20-30帖

# 总计: 55-85帖 (安全范围)
```

### 4. 请求时间窗口

**避免时段**:
- 22:00 - 08:00 (深夜请求易触发警报)
- 12:00 - 13:00 (午休高峰期)

**推荐时段**:
- 09:00 - 11:00 (上午工作时段)
- 14:00 - 17:00 (下午工作时段)
- 20:00 - 21:00 (晚间休闲时段)

---

## 监控与应急

### 执行前检查清单

```bash
# 1. 检查登录状态
cd ~/.agents/skills/xiaohongshu/scripts
./status.sh

# 2. 确保服务已启动
./start-mcp.sh

# 3. 测试单次请求
./mcp-call.sh search_feeds '{"keyword": "湾区美食", "num": 5}'
```

### 异常处理流程

```
如果遇到以下情况，立即停止:

❌ 请求超时/失败率>20%
❌ 返回验证码页面
❌ 提示"操作频繁"
❌ 账号被强制登出

应急步骤:
1. 立即停止脚本 (Ctrl+C)
2. 等待30-60分钟
3. 检查账号状态 (网页端能否正常访问)
4. 如正常，降低50%频率后继续
5. 如异常，暂停24小时后再试
```

---

## 技术实现细节

### fetch_xiaohongshu_data.sh 关键代码

```bash
# 获取帖子详情后
sleep $((RANDOM % 6 + 3))  # 3-8秒随机延迟

# 每5帖后
if [ $((count % 5)) -eq 0 ]; then
    sleep 15  # 长休息
fi

# 关键词间
sleep $((RANDOM % 8 + 8))  # 8-15秒随机延迟

# 每3关键词后
if [ $((query_count % 3)) -eq 0 ]; then
    sleep $((RANDOM % 10 + 20))  # 20-30秒随机
fi

# 每10关键词后
if [ $((query_count % 10)) -eq 0 ]; then
    sleep 60  # 60秒超长休息
fi
```

---

## 风险提示

| 风险等级 | 场景 | 概率 | 应对 |
|---------|------|------|------|
| 🔴 高 | 单日获取>100帖 | 80%封号 | 分批执行，单日≤50 |
| 🟡 中 | 深夜高频请求 | 50%限制 | 避开22:00-08:00 |
| 🟡 中 | 固定间隔请求 | 40%警告 | 使用随机延迟 |
| 🟢 低 | 正常使用+随机延迟 | <5% | 当前策略安全 |

---

## 推荐执行计划

### 保守方案 (推荐)
```bash
# 分3天执行，每天约30分钟

# Day 1 (今天)
./scripts/fetch_xiaohongshu_data.sh search
# 预计: 10-15帖，耗时15分钟

# Day 2 (明天)  
./scripts/fetch_xiaohongshu_data.sh search
# 预计: 10-15帖，耗时15分钟

# Day 3 (后天)
./scripts/fetch_xiaohongshu_data.sh search
# 预计: 10-15帖，耗时15分钟

# 总计: 30-45帖 + 原有4帖 = 34-49帖
# 足够支撑100+餐厅的去重分析
```

### 进取方案 (有经验后)
```bash
# 分2天执行，每天约45分钟

# Day 1: 20个关键词
# Day 2: 20个关键词

# 总计: 60-80帖
```

---

## 账号安全建议

1. **使用备用账号** (如果有)
2. **避免多设备同时登录**  
3. **执行期间不要人工使用小红书**
4. **定期检查登录状态**
5. **保留原始cookies备份**

---

**总结**: 当前方案采用保守策略，通过随机延迟、分批执行、控制单日上限来最大化安全性。预计3天内可安全获取30-50个高质量帖子，足够支撑项目需求。🎩