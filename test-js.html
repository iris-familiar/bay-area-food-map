<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>JS测试</title>
</head>
<body>
    <div id="loading">正在加载...</div>
    <div id="content" style="display:none"></div>
    <div id="result"></div>
    
    <script>
        let restaurants = [];
        let filteredRestaurants = [];
        let currentFilter = { cuisine: 'all', area: 'all', region: 'all' };
        let currentSort = 'engagement-desc';
        let searchMapping = {};
        
        // Region mappings
        const regionValueMap = {
            'south-bay': 'South Bay',
            'east-bay': 'East Bay', 
            'peninsula': 'Peninsula',
            'sf': 'SF'
        };
        
        const regionCities = {
            'south-bay': ['Sunnyvale', 'Cupertino', 'Milpitas', 'Mountain View', 'San Jose', 'Santa Clara', 'Campbell', 'Fremont'],
            'east-bay': ['Fremont', 'San Leandro', 'Newark', 'Albany'],
            'peninsula': ['Palo Alto', 'San Mateo', 'Millbrae'],
            'sf': ['SF', 'San Francisco']
        };
        
        async function test() {
            const result = document.getElementById('result');
            
            try {
                result.innerHTML += '<p>开始加载...</p>';
                
                const response = await fetch('data/current/restaurant_database.json?v=' + Date.now());
                result.innerHTML += '<p>响应状态: ' + response.status + '</p>';
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                
                const data = await response.json();
                result.innerHTML += '<p>数据解析成功</p>';
                result.innerHTML += '<p>餐厅数量: ' + (data.restaurants?.length || 0) + '</p>';
                
                restaurants = data.restaurants || [];
                
                // Apply filters (same logic as index.html)
                filteredRestaurants = restaurants.filter(r => !r._status || r._status !== 'duplicate_merged');
                result.innerHTML += '<p>筛选后: ' + filteredRestaurants.length + '</p>';
                
                // Test sort
                const [field, direction] = currentSort.split('-');
                result.innerHTML += '<p>排序字段: ' + field + '</p>';
                
                if (field === 'engagement') {
                    const isAsc = direction === 'asc';
                    filteredRestaurants.sort((a, b) => {
                        const aVal = a.total_engagement || 0;
                        const bVal = b.total_engagement || 0;
                        return isAsc ? aVal - bVal : bVal - aVal;
                    });
                    result.innerHTML += '<p>排序完成</p>';
                }
                
                // Test render
                if (filteredRestaurants.length > 0) {
                    const r = filteredRestaurants[0];
                    result.innerHTML += '<p>第一个餐厅: ' + r.name + '</p>';
                    result.innerHTML += '<p>total_engagement: ' + (r.total_engagement || 'undefined') + '</p>';
                    result.innerHTML += '<p>engagement: ' + (r.engagement || 'undefined') + '</p>';
                }
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                result.innerHTML += '<p style="color:green">✓ 测试完成</p>';
                
            } catch (e) {
                result.innerHTML += '<p style="color:red">❌ 错误: ' + e.message + '</p>';
                result.innerHTML += '<pre>' + e.stack + '</pre>';
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        test();
    </script>
</body>
</html>
