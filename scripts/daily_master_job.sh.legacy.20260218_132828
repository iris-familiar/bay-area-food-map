#!/bin/bash
# =============================================================================
# Daily Master Job
# æ¯å¤©åªè¿è¡Œä¸€æ¬¡ï¼Œå®Œæˆæ‰€æœ‰æ•°æ®æ”¶é›†å·¥ä½œ
# =============================================================================

# é…ç½®
PROJECT_DIR="${HOME}/.openclaw/workspace-planner/projects/bay-area-food-map"
LOG_FILE="${PROJECT_DIR}/logs/daily_$(date +%Y%m%d).log"
LOCK_FILE="${PROJECT_DIR}/.daily_job.lock"

# é˜²æ­¢é‡å¤è¿è¡Œ
if [ -f "$LOCK_FILE" ]; then
    echo "âš ï¸  Daily job already running (lock file exists)"
    echo "   PID: $(cat $LOCK_FILE)"
    exit 1
fi

# åˆ›å»ºé”æ–‡ä»¶
echo $$ > "$LOCK_FILE"

# æ¸…ç†é”æ–‡ä»¶çš„å‡½æ•°
cleanup() {
    rm -f "$LOCK_FILE"
    echo "âœ… Lock file cleaned up"
}
trap cleanup EXIT

# å¼€å§‹æ—¥å¿—
exec > >(tee -a "$LOG_FILE")
exec 2>&1

echo "======================================================================"
echo "ğŸŒ… Daily Master Job - $(date '+%Y-%m-%d %H:%M:%S')"
echo "======================================================================"
echo ""

cd "$PROJECT_DIR"

# =============================================================================
# PHASE 1: Automated Tasks (Always run)
# =============================================================================
echo "ğŸ¤– PHASE 1: Automated Background Tasks"
echo "----------------------------------------------------------------------"

# 1.1 Analyze daily data for new posts (replaces check_bloggers.py)
echo "[1/3] Analyzing daily data for new posts..."
node scripts/analyze-daily-data.js 2>&1 | tee -a logs/daily_analysis.log || echo "âš ï¸  Daily analysis had issues, continuing..."
echo ""

# 1.2 Recursive search - track existing restaurants (rotate 5 per day)
echo "[2/3] Recursive search - tracking existing restaurants..."
python3 scripts/generate_recursive_search.py data/current/restaurant_database.json 5 2>&1 | tee -a logs/recursive.log || echo "âš ï¸  Recursive search not configured, skipping..."
# Execute the generated search plan if exists
LATEST_RECURSIVE_SCRIPT=$(ls -t scripts/run_recursive_search_*.sh 2>/dev/null | head -1)
if [ -n "$LATEST_RECURSIVE_SCRIPT" ]; then
    echo "Executing: $LATEST_RECURSIVE_SCRIPT"
    bash "$LATEST_RECURSIVE_SCRIPT" 2>&1 | tee -a logs/recursive_execution.log || echo "âš ï¸  Recursive execution had issues, continuing..."
fi
echo ""

# 1.3 Update existing post engagement
echo "[3/3] Updating existing post engagement..."
node scripts/update_post_engagement.js 2>&1 | tee -a logs/engagement_update.log || echo "âš ï¸  Engagement update had issues, continuing..."
echo ""

# 1.5 Update existing post engagement (NEW)
echo "[NEW] Updating existing post engagement..."
node scripts/update_post_engagement.js 2>&1 | tee -a logs/engagement_update.log
echo ""

# =============================================================================
# PHASE 2: Main Batch Job (The Big One)
# =============================================================================
echo "ğŸ¯ PHASE 2: Main Batch Collection"
echo "----------------------------------------------------------------------"

# è¿è¡Œç«¯åˆ°ç«¯æ‰¹å¤„ç†
bash scripts/end_to_end_batch.sh

if [ $? -ne 0 ]; then
    echo "âš ï¸  Batch job had issues, but continuing..."
fi
echo ""

# =============================================================================
# PHASE 3: Post-Processing
# =============================================================================
echo "ğŸ”§ PHASE 3: Post-Processing"
echo "----------------------------------------------------------------------"

# 3.1 Validate new restaurants (if any)
echo "[1/3] Validating new restaurants..."
if [ -f "data/batch*_candidates.json" ]; then
    python3 scripts/validate_candidates.py 2>&1 | tee -a logs/validation.log
fi
echo ""

# 3.2 Auto quality fix (NEW)
echo "[2/4] Auto quality fix..."
node scripts/auto_quality_fix.js 2>&1 | tee -a logs/quality_fix.log
echo ""

# 3.3 Apply corrections (é˜²æ­¢äººå·¥ä¿®å¤è¢«è¦†ç›–)
echo "[3/4] Applying corrections..."
node scripts/apply_corrections.js 2>&1 | tee -a logs/corrections.log

# åŒæ­¥åˆ°UIç‰ˆæœ¬
cp "data/current/restaurant_database.json" \
   "data/current/restaurant_database_v5_ui.json"
echo "   âœ… Corrections applied and synced to UI version"
echo ""

# 3.4 Generate daily report
echo "[4/4] Generating daily report..."
python3 scripts/daily_report.py 2>&1 | tee -a logs/daily.log || echo "âš ï¸  Daily report generation had issues, continuing..."
echo ""

# =============================================================================
# PHASE 4: Safe Data Merge (NEW - Critical for data integrity)
# =============================================================================
echo "ğŸ”§ PHASE 4: Safe Data Merge"
echo "----------------------------------------------------------------------"

# 4.1 Find and merge any new batch data
echo "[1/2] Checking for new batch data to merge..."
LATEST_BATCH=$(ls -t data/batch*_candidates.json 2>/dev/null | head -1)
if [ -n "$LATEST_BATCH" ]; then
    echo "Found batch data: $LATEST_BATCH"
    echo "Running safe merge..."
    node scripts/safe_merge.js "$LATEST_BATCH" 2>&1 | tee -a logs/safe_merge.log
    if [ $? -eq 0 ]; then
        echo "âœ… Batch data merged successfully"
    else
        echo "âš ï¸  Batch merge had issues, check logs/safe_merge.log"
    fi
else
    echo "No new batch data found"
fi
echo ""

# 4.2 Apply quality fixes and corrections
echo "[2/2] Running post-merge quality fixes..."
node scripts/auto_quality_fix.js 2>&1 | tee -a logs/quality_fix.log || echo "âš ï¸  Quality fix had issues, continuing..."
node scripts/apply_corrections.js 2>&1 | tee -a logs/corrections.log || echo "âš ï¸  Corrections had issues, continuing..."

# Sync to UI version
cp "data/current/restaurant_database_v5_ui.json" \
   "data/current/restaurant_database_v5_ui.json.backup.$(date +%Y%m%d%H%M%S)" 2>/dev/null || true
cp "data/current/restaurant_database.json" \
   "data/current/restaurant_database_v5_ui.json"
echo "   âœ… Data synced to UI version"
echo ""

# =============================================================================
# Summary
# =============================================================================
echo "======================================================================"
echo "âœ… Daily Master Job Completed!"
echo "======================================================================"
echo "Completed: $(date '+%Y-%m-%d %H:%M:%S')"
echo "Log: $LOG_FILE"
echo ""
echo "ğŸ“Š Check status:"
echo "   - Admin Dashboard: admin.html"
echo "   - Restaurant Count: $(cat data/current/restaurant_database.json 2>/dev/null | grep -c '"id": "r' || echo 'N/A')"
echo "   - Raw Files: $(ls raw/*.json 2>/dev/null | wc -l)"
echo "======================================================================"

# å‘é€é€šçŸ¥ (å¯é€‰)
# å¯ä»¥æ·»åŠ slack/discord/emailé€šçŸ¥
# ./scripts/notify.sh "Daily job completed"
